<html lang="en"> <head> <meta charset="UTF-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0"/> <title>Interactive Attribution Graph Demo</title> <script src="https://cdn.tailwindcss.com"></script> <script src="https://d3js.org/d3.v7.min.js"></script> <style>:root{--node-fill:#f2e7fa;--node-stroke:#a472d1;--edge-stroke:#d8b4fe;--dashboard-bg:#1f102f;--dashboard-text:#e0d0f5;--dashboard-border:#4b2c73}body{background:linear-gradient(180deg,#1a0033 0%,#0a0018 100%);padding:1.5rem;font-family:'Inter',sans-serif;color:var(--dashboard-text)}.node rect{fill:var(--node-fill);stroke:var(--node-stroke);stroke-width:1.2px;rx:8px}.node.input rect{rx:4px;fill:#6b21a8;stroke:#6b21a8}.node.input text{font-size:.65rem;fill:#e0d0f5}.edge-path{fill:none;stroke:var(--edge-stroke);stroke-width:2px;opacity:.8}.stack rect:nth-child(2){transform:translate(2px,2px)}.stack rect:nth-child(3){transform:translate(4px,4px)}#dashboard{position:absolute;width:24rem;max-width:90vw;max-height:80vh;overflow-y:auto;background:var(--dashboard-bg);color:var(--dashboard-text);border:1px solid var(--dashboard-border);box-shadow:0 8px 20px rgba(80,0,150,0.25);border-radius:1rem;display:none;z-index:9999;overflow-x:hidden}#feat-tabs button{background-color:#371651;color:#e0d0f5;border:1px solid #5c2f7e}#feat-tabs button.bg-gray-200{background-color:#6b21a8;color:#f3e8ff}svg#graph{border:1px solid var(--dashboard-border);border-radius:1rem;background:rgba(255,255,255,0.02)}</style> </head> <body class="antialiased p-6 select-none"> <div style="width: 100%; overflow-x: auto; overflow-y: hidden;"> <svg id="graph" height="700"></svg> </div> <aside id="dashboard"></aside> <script>function nodeById(e){return graphData.nodes.find(t=>t.id===e)}function afterDraw(){nodes.each(function(e){const t=d3.select(this);let a;"super"===e.type?(t.classed("stack",!0),[2,1,0].forEach(()=>t.append("rect").attr("width",110).attr("height",40))):a="input"===e.type?t.append("rect").attr("width",12).attr("height",30).attr("rx",4).attr("fill","#6b21a8").attr("stroke","#6b21a8"):t.append("rect").attr("width",110).attr("height",40),e.label.split(/\n/).forEach((r,s,i)=>{const n=t.append("text").attr("x","input"===e.type?8:55).attr("y",22+14*(s-(i.length-1)/2)).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("class","text-sm font-medium text-gray-800").text(r);"input"!==e.type||activeResidues.has(e.id)||(n.attr("font-size","0.3rem").attr("opacity",.1),a.attr("width",8).attr("height",30).attr("opacity",.1))})})}function scheduleHide(e=400){clearTimeout(hideId),hideId=setTimeout(()=>dash.style("display","none"),e)}function positionPanelBeside(e){const t=e.getBoundingClientRect(),a=dash.node(),r=a.offsetWidth||320;let s=t.right+16,i=t.top;s+r>window.innerWidth&&(s=t.left-r-16),i+a.offsetHeight>window.innerHeight&&(i=window.innerHeight-a.offsetHeight-16),dash.style("left",s+"px").style("top",i+"px")}function renderPanel(e){if("super"===e.type){dash.html(`<div class="p-4">\n      <h2 class="text-xl font-semibold mb-2">${e.label.replace(/\n/," ")}</h2>\n      <div class="flex gap-2 mb-3" id="feat-tabs"></div>\n      <div id="feat-content" class="text-sm leading-relaxed"></div>\n    </div>`);const t=dash.select("#feat-tabs");e.members.forEach((e,a)=>{t.append("button").text(e).attr("data-feature",e).attr("class","px-2 py-1 rounded border text-sm").classed("bg-gray-200",0===a).on("click",a=>{t.selectAll("button").classed("bg-gray-200",!1),d3.select(a.currentTarget).classed("bg-gray-200",!0),showFeature(e)})}),showFeature(e.members[0])}else dash.html(`<div class="p-4"><h2 class="text-lg font-semibold mb-2">${e.label}</h2><p class="text-sm">Type: ${e.type}</p></div>`);dash.style("display","block")}function showFeature(e){const t=graphData.features[e]||{},a=`https://interprot.com/#/sae-viz/SAE4096-L${featureLayer[e]||"unknown"}/${e.includes(".")?e.split(".")[1]:e}`;d3.select("#feat-content").html(`\n    <h3 class="font-medium mb-1 mt-4">Description</h3>\n    <p class="whitespace-pre-line mb-4">${t.description||"No description available."}</p>\n\n    <h3 class="font-medium mb-1 mt-4">Top Activations</h3>\n    <p class="whitespace-pre-line mb-4">${t.activations||"N/A"}</p>\n\n    <p class="mt-4">\n      <a href="${a}" target="_blank"\n         class="text-indigo-400 underline">\n        See InterPro visualizations here\n      </a>\n    </p>\n\n    <h3 class="font-medium mb-1 mt-4">Figures</h3>\n    ${t.fig1?`<img src="${t.fig1}" class="w-full rounded mb-4 border border-purple-400" />`:'<p class="text-sm italic mb-2">No figures defined.</p>'}\n    ${t.fig2?`<img src="${t.fig2}" class="w-full rounded mb-4 border border-purple-400" />`:""}\n    ${t.fig3?`<img src="${t.fig3}" class="w-full rounded mb-4 border border-purple-400" />`:""}\n  `)}const layerY={4:600,8:500,12:400,16:300,20:200,24:100,28:0},sequence="MSTEPVSASDKYQKISQLEHILKRPDTYIGSVETQEQLQWIYDEETDCMIEKNVTIVPGLFKIFDEILVNAADNKVRDPSMKRIDVNIHAEEHTIEVKNDGKGIPIEIHNKENIYIPEMIFGHLLTSSNYDDDEKKVTGGRNGYGAKLCNIFSTEFILETADLNVGQKYVQKWENNMSICHPPKITSYKKGPSYTKVTFKPDLTRFGMKELDNDILGVMRRRVYDINGSVRDINVYLNGKSLKIRNFKNYVELYLKSLEKKRQLDNGEDGAAKSDIPTILYERINNRWEVAFAVSDISFQQIS",mainNodes=[{id:"N_last",label:"_N",type:"super",members:["4.3170"],x:150,layer:4},{id:"D_last",label:"D_",type:"super",members:["4.527"],x:150,layer:4},{id:"G_last",label:"G_",type:"super",members:["4.3069"],x:150,layer:4},{id:"GXG_mid",label:"GXG\nHATPase",type:"super",members:["8.3903","8.1055","8.2066"],x:50,layer:8},{id:"C_spec",label:"C",type:"super",members:["4.3544"],x:50,layer:4},{id:"YX_",label:"YX_",type:"super",members:["4.2112"],x:50,layer:4},{id:"I_spec",label:"I",type:"super",members:["4.1297"],x:50,layer:4},{id:"XXN",label:"_XXN",type:"super",members:["4.1468"],x:50,layer:4},{id:"IL?",label:"IL?",type:"super",members:["4.100"],x:50,layer:4},{id:"IX_",label:"IX_",type:"super",members:["4.3229"],x:50,layer:4},{id:"N_spec",label:"N",type:"super",members:["4.2929"],x:50,layer:4},{id:"D_spec",label:"D",type:"super",members:["4.1196"],x:50,layer:4},{id:"E_spec",label:"E",type:"super",members:["4.1509"],x:50,layer:4},{id:"XQX",label:"_XQ",type:"super",members:["4.2511"],x:50,layer:4},{id:"NXXXNA",label:"NXXXNA\nHATPase",type:"super",members:["8.3159","8.1916"],x:50,layer:8},{id:"IXVXD",label:"IXVXD\nHATPase",type:"super",members:["8.2527"],x:50,layer:8},{id:"sheet_alpha",label:"Sheets around alpha",type:"super",members:["8.2662"],x:50,layer:8},{id:"alt_beta",label:"alternate Beta residues",type:"super",members:["8.2621"],x:50,layer:8},{id:"repeat_dn",label:"Repeating D,N",type:"super",members:["8.3921"],x:50,layer:8},{id:"hatpase_segment",label:"Beta in HATPase",type:"super",members:["12.3943","12.1796","12.1145"],x:50,layer:12},{id:"general_beta",label:"Beta Strands",type:"super",members:["12.2474"],x:50,layer:12},{id:"GHKL_12",label:"GHKL Domain",type:"super",members:["12.1204"],x:50,layer:12},{id:"yeast_12",label:"Yeast proteins",type:"super",members:["12.3849"],x:50,layer:12},{id:"kinesin_12",label:"Kinesin Domain",type:"super",members:["12.2472"],x:50,layer:12},{id:"xpg_12",label:"XPG-I Domain",type:"super",members:["12.1082"],x:50,layer:12},{id:"beta_16",label:"Beta in yeast",type:"super",members:["16.3666"],x:50,layer:16},{id:"hatpase_segment_16",label:"Beta in HATPase",type:"super",members:["16.1353","16.1597","16.631"],x:50,layer:16},{id:"GHKL_16",label:"GHKL Domain",type:"super",members:["16.1166","16.1280","16.737"],x:50,layer:16},{id:"beta_20",label:"Beta",type:"super",members:["20.3462","20.789","20.2366 "],x:50,layer:20},{id:"LXVXF",label:"LX[v,F]XF",type:"super",members:["20.1799"],x:50,layer:20},{id:"hatpase_segment_20",label:"Beta in HATPase",type:"super",members:["20.1108","20.432"],x:50,layer:20},{id:"GHKL_20",label:"GHKL Domain",type:"super",members:["20.2311","20.432"],x:50,layer:20}],featureLayer={};mainNodes.forEach(e=>{e.members.forEach(t=>{featureLayer[t]=e.layer})});const xStep=12,inputNodes=Array.from(sequence).map((e,t)=>({id:`residue_${t+1}`,label:`${e}\n${t+1}`,type:"input",x:t*xStep,y:700})),inputWidth=inputNodes.length*xStep+400,graphData={nodes:[...inputNodes,...mainNodes.map(e=>({...e,y:layerY[e.layer]||e.y}))],edges:[{source:"residue_133",target:"GXG_mid"},{source:"residue_134",target:"GXG_mid"},{source:"residue_135",target:"GXG_mid"},{source:"residue_28",target:"C_spec"},{source:"residue_30",target:"YX_"},{source:"residue_67",target:"I_spec"},{source:"residue_265",target:"N_last"},{source:"residue_67",target:"XXN"},{source:"residue_67",target:"IL?"},{source:"residue_68",target:"IL?"},{source:"residue_97",target:"IX_"},{source:"residue_266",target:"XQX"},{source:"residue_268",target:"E_spec"},{source:"residue_266",target:"N_spec"},{source:"residue_265",target:"D_spec"},{source:"residue_266",target:"D_last"},{source:"residue_268",target:"G_last"},{source:"residue_67",target:"NXXXNA"},{source:"residue_97",target:"IXVXD"},{source:"residue_97",target:"sheet_alpha"},{source:"residue_197",target:"sheet_alpha"},{source:"residue_197",target:"alt_beta"},{source:"residue_65",target:"repeat_dn"},{source:"residue_212",target:"repeat_dn"},{source:"residue_213",target:"repeat_dn"},{source:"residue_266",target:"repeat_dn"},{source:"residue_98",target:"hatpase_segment"},{source:"residue_195",target:"hatpase_segment"},{source:"residue_197",target:"hatpase_segment"},{source:"residue_197",target:"general_beta"},{source:"residue_197",target:"GHKL_12"},{source:"residue_197",target:"yeast_12"},{source:"residue_97",target:"xpg_12"},{source:"residue_197",target:"kinesin_12"},{source:"residue_197",target:"beta_16"},{source:"residue_195",target:"hatpase_segment_16"},{source:"residue_196",target:"hatpase_segment_16"},{source:"residue_197",target:"hatpase_segment_16"},{source:"residue_199",target:"hatpase_segment_16"},{source:"residue_201",target:"hatpase_segment_16"},{source:"residue_195",target:"GHKL_16"},{source:"residue_197",target:"GHKL_16"},{source:"residue_199",target:"GHKL_16"},{source:"residue_201",target:"GHKL_16"},{source:"residue_197",target:"beta_20"},{source:"residue_197",target:"LXVXF"},{source:"residue_199",target:"LXVXF"},{source:"residue_195",target:"hatpase_segment_20"},{source:"residue_197",target:"hatpase_segment_20"},{source:"residue_199",target:"hatpase_segment_20"},{source:"residue_195",target:"GHKL_20"}],features:{8.3903:{description:"Fires on GXG pattern, this is present in 1PVG but is masked. It has causal effect over tokens right before GYG, so hypothesis: approximate masked token prediction. Fires over D133,E134,K135. Top proteins also share HATPase domain and atp binding function.",activations:""},8.1055:{description:"Fires on GXG pattern, this is present in 1PVG but is masked. It has causal effect over tokens right before GYG, so hypothesis: approximate masked token prediction. Fires on V97 and 127:136. Top proteins also share HATPase domain and atp binding function.",activations:""},8.2066:{description:"Fires on GXG pattern, this is present in 1PVG but is masked. It has causal effect over tokens right before GYG, so hypothesis: approximate masked token prediction. Fires over D133,E134,K135. Top proteins also share HATPase domain and atp binding function.",activations:""},"4.3170":{description:"Fires right before N, inhibitory causal effect at 265D",activations:"",fig1:"circuits_1pvg_jump/l4_3170.png",fig2:"circuits_1pvg_jump/pattern_N.png"},4.527:{description:"Fires right after D, inhibitory causal effect at 266N",activations:"",fig1:"circuits_1pvg_jump/l4_527.png",fig2:"circuits_1pvg_jump/D_pattern.png"},4.3069:{description:"Fires right after G, casual effect at 268G which is masked in clean.",activations:"",fig1:"circuits_1pvg_jump/l4_3069.png",fig2:"circuits_1pvg_jump/G_pattern.png"},4.2511:{description:"Fires on _XQ, but also QX_ but weaker. Latter is present.",activations:"",fig1:"circuits_1pvg_jump/l4_2511.png",fig2:"circuits_1pvg_jump/pattern_XQ.png"},4.3229:{description:"Fires on IX_, causal effect on V97, which has IE before it.",activations:""},4.1468:{description:"Fires on _XXN, effect on I67 before LVN.",activations:""},"4.100":{description:"Fires on around IL? unsure but new residues increase activation on I67,I86",activations:"",fig1:"circuits_1pvg_jump/l4_100_1.png",fig2:"circuits_1pvg_jump/l4_100_cons.png",fig3:"circuits_1pvg_jump/l4_100_IL.png"},4.2112:{description:"Fires on YX_, fires on G30, which has YIG. Y was masked in corrupted. ",activations:"",fig1:"circuits_1pvg_jump/l4_2112.png",fig2:"circuits_1pvg_jump/l4_2112_cons.png",fig3:"circuits_1pvg_jump/YX_pattern.png"}}},svg=d3.select("#graph"),linkG=svg.append("g"),nodeG=svg.append("g"),dash=d3.select("#dashboard");let hideId=null;svg.attr("width",inputWidth);const layerGuideG=svg.append("g").attr("pointer-events","none");Object.entries(layerY).forEach(([e,t])=>{layerGuideG.append("line").attr("x1",0).attr("y1",t+20).attr("x2",inputWidth).attr("y2",t+20).attr("stroke","#9e7ac4").attr("stroke-dasharray","4 4").attr("opacity",.35),d3.select("body").append("div").style("position","fixed").style("left","8px").style("top",`${t+30}px`).style("color","#e0d0f5").style("font-size","0.75rem").style("pointer-events","none").text(`Layer ${e}`)});const bandData=[{start:27,end:28,label:"clean"},{start:92,end:102,label:"SSE-1"},{start:192,end:202,label:"SSE-2"},{start:267,end:268,label:"clean"},{start:29,end:91,label:"unmasked",color:"#45306d"},{start:203,end:266,label:"unmasked",color:"#45306d"}],bandG=svg.insert("g","g");bandData.forEach(e=>{const t=(e.start-1)*xStep,a=(e.end-e.start+1)*xStep;bandG.append("rect").attr("x",t).attr("y",750).attr("width",a).attr("height",40).attr("fill",e.color||"#6a5499").attr("opacity",.45).attr("rx",4),bandG.append("text").attr("x",t+a/2).attr("y",772).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("font-size","0.65rem").attr("fill","#e0d0f5").text(e.label)});const residueConnections={},activeResidues=new Set;graphData.edges.forEach(e=>{e.source.startsWith("residue_")&&activeResidues.add(e.source)}),graphData.edges.forEach(e=>{e.source.startsWith("residue_")&&(residueConnections[e.target]||(residueConnections[e.target]=[]),residueConnections[e.target].push(e.source))});const bumpThreshold=60,bumpAmount=120,placedXByLayer={};graphData.nodes.forEach(e=>{if("input"!==e.type&&residueConnections[e.id]){const t=residueConnections[e.id];let a=t.reduce((e,t)=>e+nodeById(t).x,0)/t.length;const r=e.members&&e.members.length>0?e.members[0]:null,s=featureLayer[r]||e.layer;for(placedXByLayer[s]||(placedXByLayer[s]=[]);placedXByLayer[s].some(e=>Math.abs(e-a)<bumpThreshold);)a+=bumpAmount;e.x=a,placedXByLayer[s].push(a)}}),linkG.selectAll("path").data(graphData.edges).enter().append("path").attr("d",e=>`M${nodeById(e.source).x+8},${nodeById(e.source).y} L${nodeById(e.target).x+55},${nodeById(e.target).y+40}`).attr("class","edge-path");const nodes=nodeG.selectAll("g").data(graphData.nodes).enter().append("g").attr("class",e=>`node ${e.type}`).attr("transform",e=>`translate(${e.x},${e.y})`);afterDraw(),nodes.on("pointerenter",function(e,t){clearTimeout(hideId),renderPanel(t),positionPanelBeside(e.currentTarget)}),nodes.on("pointerleave",()=>scheduleHide()),dash.on("pointerenter",()=>clearTimeout(hideId)),dash.on("pointerleave",()=>scheduleHide());const maxY=Math.max(...graphData.nodes.map(e=>e.y))+150;svg.attr("height",maxY);</script> </body> </html>